<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edition de la fonction - PHP Functions</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css"
    />

    <style type="text/css" media="screen">
      #editor {
        position: relative;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        height: 70vh;
        font-size: 18px;
      }

      .section {
        padding-top: 0;
      }
    </style>

    <script
      type="text/javascript"
      src="https://identity.netlify.com/v1/netlify-identity-widget.js"
    ></script>
  </head>

  <body onload="load_function()">
    <section class="section">
      <div class="container is-fullhd">
        <div
          class="notification mb-0 is-light is-flex is-justify-content-space-between is-align-items-center"
        >
          <h1 class="is-unselectable">
            <a href=".">
              <span class="icon is-small">
                <svg
                  class="w-6 h-6"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z"
                    clip-rule="evenodd"
                  ></path>
                </svg> </span
              >Liste des fonctions
            </a>
          </h1>
          <div id="sec-url" class="field is-horizontal mb-0 is-hidden">
            <div class="field-body">
              <div class="field is-expanded">
                <div class="field has-addons">
                  <p class="control">
                    <a class="button is-static is-small"></a>
                  </p>
                  <button class="button is-small is-link" onclick="test()">
                    <span>Tester</span>
                    <span class="icon is-small">
                      <svg
                        class="w-6 h-6"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"
                        ></path>
                        <path
                          d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"
                        ></path>
                      </svg>
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button
            id="btn-save"
            class="button is-small is-success"
            onclick="save()"
          >
            <span class="icon is-small">
              <svg
                class="w-6 h-6"
                fill="currentColor"
                viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"
                ></path>
              </svg>
            </span>
            <span>Enregistrer les modifications</span>
          </button>
          <p
            id="msg-save"
            class="is-italic is-size-7 is-hidden has-text-weight-bold"
          ></p>
        </div>
        <div id="editor" class="is-hidden"></div>
      </div>
    </section>

    <script
      defer
      src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"
    ></script>
    <script src="assets/js/ace/ace.js"></script>
    <script>
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/php");
      editor.commands.addCommand({
        name: "save",
        bindKey: { win: "Ctrl-S", mac: "Cmd-S" },
        exec: function (editor) {
          save();
        },
      });
    </script>

    <script>
      window.baseURL = "https://mende.alwaysdata.net/funcs/";

      netlifyIdentity.setLocale("fr");

      netlifyIdentity.on("init", (user) => {
        if (!user) {
          location.href = "/login";
        } else {
          document.querySelector("body").classList.remove("is-hidden");
        }
      });

      function test() {
        const funcUrl = document.querySelector("a.is-static").textContent;
        window.open(funcUrl, "TestWindow");
      }

      function load_function() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const funcUrl = urlParams.get("url");

        if (!funcUrl) return;

        document.querySelector("a.is-static").textContent = funcUrl;
        document.querySelector("#sec-url").classList.toggle("is-hidden");
        const endpoint = funcUrl.replace(window.baseURL, "");

        get_code(endpoint);
      }

      function get_code(endpoint) {
        fetch(`${window.baseURL}code/${endpoint}`)
          .then((res) => {
            return res.json();
          })
          .then((res) => {
            document.querySelector("#editor").classList.toggle("is-hidden");
            editor.insert(res.code);
          })
          .catch((err) => {
            console.error(err);
          });
      }

      function save() {
        document.querySelector("#btn-save").classList.toggle("is-hidden");
        const message = document.querySelector("#msg-save");

        message.classList.remove("has-text-danger-dark");
        message.classList.remove("has-text-success-dark");
        message.classList.remove("is-hidden");
        message.textContent = "Enregistrement en cours ...";

        const funcUrl = document
          .querySelector("a.is-static")
          .textContent.replace(window.baseURL, "");
        const endpoint = funcUrl.replace("public/", "");

        if (!endpoint) return;
        const func = {
          owner: "public",
          name: endpoint,
          code: editor.getValue(),
        };
        fetch(`${window.baseURL}save`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `funcowner=${func.owner}&funcname=${func.name}&funccode=${func.code}`,
        })
          .then((res) => {
            return res.json();
          })
          .then((res) => {
            message.textContent = "Modifications enregistrées";
            message.classList.toggle("has-text-success-dark");
            setTimeout(() => {
              document.querySelector("#btn-save").classList.toggle("is-hidden");
              message.classList.toggle("is-hidden");
            }, 3 * 1000);
          })
          .catch((err) => {
            message.textContent = "Modifications non enregistrées";
            message.classList.toggle("has-text-danger-dark");
            setTimeout(() => {
              document.querySelector("#btn-save").classList.toggle("is-hidden");
              message.classList.toggle("is-hidden");
            }, 3 * 1000);
            console.error(err);
          });
      }
    </script>
  </body>
</html>
